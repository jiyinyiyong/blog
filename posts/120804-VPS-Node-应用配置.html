<title>VPS 运行 Node 应用</title><meta charset='utf-8'>  <div id='article'><a id='home' href='../index.html'>Home</a><link rel="stylesheet" href="../style.css"><pre> </pre><pre><pre class='title'>VPS 运行 Node 应用</pre></pre><pre> </pre><pre>先试试盛大云的免费 VPS, 然后买了 30 多的 Burst VPS,</pre><pre>挂载 sshfs 把系统弄到不能 ssh, 于是重新配置了前两天摸索的东西</pre><pre>因为之前在 98 上配过, 这两天步骤基本清晰的, 然后解决掉了一个问题</pre><pre>关于细节我并不清晰, 怎么简单怎么来了, 具体请仔细看英文资源</pre><pre><a href="http://howtonode.org/deploying-node-upstart-monit">howtonode.org/deploying-node-upstart-monit</a></pre><pre><a href="http://spektom.blogspot.com/2010/12/having-fun-with-nodejs.html">spektom.blogspot.com/2010/12/having-fun-with-nodejs.html</a></pre><pre> </pre><pre><b>Node 安装</b></pre><pre>手动安装的软件:</pre><pre class='code_block'><pre>sudo apt-get install python-software-properties -y</pre><pre>sudo apt-add-repository ppa:chris-lea/node.js</pre><pre>sudo aptitude update</pre><pre>sudo aptitude install nodejs npm mongodb nginx monit -y</pre><pre>sudo npm install -g stylus jade doodle ws socket.io mongodb coffee-script</pre></code></pre><pre>添加 PATH:</pre><pre class='code_block'><pre>export NODE_PATH="/usr/lib/node_modules/"</pre></code></pre><pre> </pre><pre><b>monit 配置</b></pre><pre>网上监视 Node 运行用到了 <code class="inline_code">upstart</code>, 最开始我用过, 但后来换了</pre><pre>因为 <code class="inline_code">upstart</code> 功能和 <code class="inline_code">monit</code> 有重叠, 重启功能还导致我操作失误过</pre><pre>配置为系统 daemon 的好处是随系统启动, monit 大概还不行, 但可以尝试脚本</pre><pre>中间一段 <code class="inline_code">env</code> 设置我大致在网上看到过, 后来摸索出来了, 是必要的</pre><pre> </pre><pre class='code_block'><pre>check host demo with address 127.0.0.1</pre><div class='code_block'><div class='code_block'><pre>start program = "/usr/bin/env NODE_PATH=/usr/lib/node_modules /usr/bin/coffee /home/chen/coffee/demo/demo.coffee"</pre><pre>stop program  = "/usr/bin/pkill -f '/home/chen/coffee/demo/demo.coffee'"</pre><pre>if failed port 3001 protocol HTTP</pre><div class='code_block'><div class='code_block'><pre>request /</pre><pre>with timeout 10 seconds</pre><pre>then restart</pre></div></div></div></div></code></pre><pre> </pre><pre><b>nginx 配置</b></pre><pre>单个的应用是这个样子的, 全部从网上抄的, 没有异议</pre><pre>不过今天发现这样配置 <code class="inline_code">socket.io</code> 还会出错, 在 CNode 发贴求助没解决</pre><pre><a href="http://cnodejs.org/topic/501ceb69f767cc9a51b38c6f">cnodejs.org/topic/501ceb69f767cc9a51b38c6f</a></pre><pre> </pre><pre class='code_block'><pre>upstream demo {</pre><div class='code_block'><div class='code_block'><pre>server 127.0.0.1:3001;</pre></div></div><pre>}</pre><pre> </pre><pre>server {</pre><div class='code_block'><div class='code_block'><pre>listen 0.0.0.0:80;</pre><pre>server_name demo.jiyinyiyong.info;</pre><pre>access_log /var/log/nginx/demo.log;</pre><pre> </pre><pre>location / {</pre><div class='code_block'><pre>proxy_set_header X-Real-IP $remote_addr;</pre><pre>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</pre><pre>proxy_set_header Host $http_host;</pre><pre>proxy_set_header X-NginX-Proxy true;</pre><pre> </pre><pre>proxy_pass http://demo;</pre><pre>proxy_redirect off;</pre></div><pre>}</pre></div></div><pre> }</pre></code></pre><pre> </pre><pre><b>静态文件</b></pre><pre>另外测试 <code class="inline_code">socket.io</code> 经常遇到跨域之类问题, 用 nginx 解决更方便</pre><pre>这是静态文件的配置, 我老是忘掉, 索性记录一下</pre><pre> </pre><pre class='code_block'><pre>server {</pre><div class='code_block'><pre>listen 80;</pre><pre>server_name s.jiyinyiyong.info;</pre><pre>access_log  /var/log/nginx/x.access.log</pre><pre>charset utf-8;</pre><pre>root /home/chen/s;</pre><pre>autoindex on;</pre></div><pre> }</pre></code></pre><pre> </pre><pre><b>检查端口占用</b></pre><pre>netstat -an | grep "LISTEN "</pre><pre> </pre><pre><b>踢出 ssh 登录用户</b></pre><pre>添加代码避免因 ssh 时间限制而被踢 <code class="inline_code">ServerAliveInterval 60</code></pre><pre><a href="http://linux-wiki.cn/wiki/zh-hans/避免SSH连接因超时闲置断开">linux-wiki.cn/wiki/zh-hans/避免SSH连接因超时闲置断开</a></pre><pre><code class="inline_code">who</code> 命令查看用户, 再用 <code class="inline_code">pkill -kill -t</code> 踢出对应用户</pre><pre><a href="http://wenwen.soso.com/z/q302245848.htm">wenwen.soso.com/z/q302245848.htm</a></pre><pre> </pre><div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'jiyinyiyong';
      // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          if (document.getElementsByTagName('head')[0]) {
            document.getElementsByTagName('body')[0].appendChild(dsq);
          }
      })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
      comments powered by Disqus.
    </a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">
    comments powered by
    <span class="logo-disqus">
      Disqus
    </span>
  </a>
</div></div>