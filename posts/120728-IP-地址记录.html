<title>记录我的 IP 地址</title><meta charset='utf-8'>  <div id='article'><a id='home' href='../index.html'>Home</a><link rel="stylesheet" href="../style.css"><pre> </pre><pre><pre class='title'>记录我的 IP 地址</pre></pre><pre> </pre><pre>家里老的电脑装上一台 Ubuntu, 但管理 Ubuntu 的细节家里没人</pre><pre>我寻思以后远程 ssh 登录管理应该不错的, 但是 IP 地方没有办法, 求助论坛</pre><pre><a href="http://forum.ubuntu.org.cn/viewtopic.php?f=48&t=381745">forum.ubuntu.org.cn/viewtopic.php?f=48&t=381745</a></pre><pre>我得到的思路是从本地不停往服务段发送信息, 更新设置</pre><pre>于是我想到干脆 Heroku 放一个应用, 我这里访问过去看 IP 的更新</pre><pre> </pre><pre>大致想法是这样, 客户端通过 URL 的参数发送过去 IP, 附带密码</pre><pre>IP 可以通过调用 <code class="inline_code">ifconfig</code> 然后解析字符串获得, 可行</pre><pre>发送用 nodejs 模拟一个请求, 然后就是网页的更新部分了</pre><pre> </pre><pre>服务器的代码基本是这样的:</pre><pre class='code_block'><pre>url = require 'url'</pre><pre>http = require 'http'</pre><pre>querystring = require 'querystring'</pre><pre> </pre><pre>history = []</pre><pre>f = (n) -&gt; if n &lt; 10 then '0' + n else n</pre><pre>time = -&gt;</pre><div class='code_block'><pre>now = new Date()</pre><pre>m = f (now.getMonth() + 1)</pre><pre>d = f now.getDate()</pre><pre>h = f now.getHours()</pre><pre>n = f now.getMinutes()</pre><pre>s = f now.getSeconds()</pre><pre>"#{m}/#{d} #{h}:#{n}:#{s}"</pre></div><pre>gen = (obj) -&gt;</pre><div class='code_block'><pre>"&lt;code&gt;#{obj.time} -- #{obj.ip}&lt;/code&gt;&lt;br&gt;"</pre></div><pre> </pre><pre>server = http.createServer (req, res) -&gt;</pre><div class='code_block'><pre>obj = url.parse req.url</pre><pre># console.log obj</pre><pre>p = obj.pathname</pre><pre>if p is '/update'</pre><div class='code_block'><pre>{ip, passwd} = querystring.parse obj.query</pre><pre>if ip? and passwd is 'home'</pre><div class='code_block'><pre>stemp = time()</pre><pre>if history[0]?.time[...-1] is stemp[...-1]</pre><div class='code_block'><pre>history.shift()</pre></div><pre>history.unshift ip: ip, time: stemp</pre></div><pre>res.end ''</pre></div><pre>else if p is '/'</pre><div class='code_block'><pre>res.writeHead 200, 'Content-Type': 'text/html'</pre><pre>res.end history.map(gen).join('')</pre></div><pre>else res.end ''</pre></div><pre> </pre><pre>port = process.env.PORT or 8000</pre><pre>server.listen port</pre></code></pre><pre> </pre><pre>然后发送有现成的 <code class="inline_code">http.get()</code> 可用:</pre><pre><a href="http://nodejs.org/api/http.html#http_http_get_options_callback">nodejs.org/api/http.html#http_http_get_options_callback</a></pre><pre>但我法先调试起来不对, 就先将代码运行到 Heroku 上去</pre><pre>安装 <code class="inline_code">ruby1.9.1</code> 并添加淘宝的镜像来安装 <code class="inline_code">heroku</code> 命令工具.</pre><pre><a href="http://ruby.taobao.org/">ruby.taobao.org/</a></pre><pre>安装完成 <code class="inline_code">heroku</code> 先登录, 注意终端使用了代理的话登录出错,</pre><pre>之后俺下面的手法配置 Heroku 环境, 注意要 key</pre><pre><a href="https://devcenter.heroku.com/articles/nodejs">devcenter.heroku.com/articles/nodejs</a></pre><pre><a href="http://stackoverflow.com/questions/6356267/can-i-run-coffeescript-in-heroku">stackoverflow.com/questions/6356267/can-i-run-coffeescript-in-heroku</a></pre><pre class='code_block'><pre>heroku keys:clear</pre><pre>heroku keys:add ~/.ssh/id_rsa.pub</pre></code></pre><pre>然后按 Git 的步骤推一遍就成功了</pre><pre><a href="http://address-log.herokuapp.com/">address-log.herokuapp.com/</a></pre><pre> </pre><pre>客户端的代码是</pre><pre class='code_block'><pre>http = require 'http'</pre><pre>send = -&gt;</pre><div class='code_block'><pre>ip = '12.34'</pre><pre>url = "http://address-log.herokuapp.com/update?ip=#{ip}&passwd=home"</pre><pre>p = http.get url, (res) -&gt; console.log res</pre><pre>p.on 'error', (err) -&gt; console.log err</pre></div><pre>setInterval send, 1000</pre></code></pre><pre> </pre><pre>代码我放到 GitCafe 上去了, 对然短到没有必要:</pre><pre><a href="http://gitcafe.com/jiyinyiyong/address-log">gitcafe.com/jiyinyiyong/address-log</a></pre><pre>实际用的参数应该是一分钟一次更新, 或者更长, repo 里会改, 还有密码</pre><pre>为了环境随着开机启动, 还要在系统里设置登录启动</pre><pre> </pre><div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'jiyinyiyong';
      // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          if (document.getElementsByTagName('head')[0]) {
            document.getElementsByTagName('body')[0].appendChild(dsq);
          }
      })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
      comments powered by Disqus.
    </a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">
    comments powered by
    <span class="logo-disqus">
      Disqus
    </span>
  </a>
</div></div>