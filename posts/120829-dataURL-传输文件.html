<title>dataURL 传输文件</title><meta charset='utf-8'>  <div id='article'><a id='home' href='../index.html'>Home</a><link rel="stylesheet" href="../style.css"><pre> </pre><pre><pre class='title'>dataURL 传输文件</pre></pre><pre> </pre><pre>一直很想知道怎么从浏览器上传文件, 曾经在社区问过, 没有好的结果</pre><pre><a href="http://cnodejs.org/topic/4f8f54f8407edba21416cf60">cnodejs.org/topic/4f8f54f8407edba21416cf60</a></pre><pre>当时找到了一个款叫做 <code class="inline_code">delivery</code> 的模块, 可以在 <code class="inline_code">socket.io</code> 当中传输文件</pre><pre><a href="https://github.com/liamks/Delivery.js">github.com/liamks/Delivery.js</a></pre><pre>也一直不知道怎么实现的, 最初虽然动过 File API 一类的代码, 也没成功</pre><pre>然后因为现在对 HTTP 协议熟悉度有所提高了, 开始稍稍理解</pre><pre><a href="https://twitter.com/jiyinyiyong/status/240790389446021120">twitter.com/jiyinyiyong/status/240790389446021120</a></pre><pre>推测上传就是 Node 处理 POST 请求存放数据的过程</pre><pre> </pre><pre>然后回去看网上介绍 File API 的文档, 这一次我慢慢看懂了</pre><pre><a href="http://www.html5rocks.com/zh/tutorials/file/dndfiles/">www.html5rocks.com/zh/tutorials/file/dndfiles/</a></pre><pre>并确认浏览器支持, Firefox 和 Chrome 双双支持的</pre><pre><a href="http://caniuse.com/#feat=fileapi">caniuse.com/#feat=fileapi</a></pre><pre>然后自己仿写了一个版本, 前端的部分的代码是这样的</pre><pre> </pre><pre>jade:</pre><pre class='code_block'><pre>body</pre><div class='code_block'><pre>input(id='file', type='file', multiple='')</pre></div></code></pre><pre> </pre><pre>coffee:</pre><pre class='code_block'><pre>show = (x) -&gt; console.log x</pre><pre>hostname = location.hostname</pre><pre>s = io.connect "#{hostname}:8001"</pre><pre>$ -&gt;</pre><div class='code_block'><pre>$('#file').bind 'change', (e) -&gt;</pre><div class='code_block'><pre>files = e.target.files</pre><pre>reader = new FileReader()</pre><pre>reader.onload = (file) -&gt;</pre><div class='code_block'><pre>res = file.target.result</pre><pre>show 'sending'</pre><pre>s.emit 'dataURL', res</pre></div><pre>reader.readAsDataURL files[0]</pre></div></div></code></pre><pre> </pre><pre>开始我很想知道读出来是什么数据, 后来看到方法名, 反应过来是 dataURL</pre><pre>印象里 canvas 图片的 dataURL 我听说过的, 输入到地址栏可以显示图片</pre><pre><a href="http://www.blackglory.co.cc/canvas-convert-the-picture-to-dataurl/">www.blackglory.co.cc/canvas-convert-the-picture-to-dataurl/</a></pre><pre>做了更多的搜多之后防线支持更多的文件类型, 于是我就明白了</pre><pre><a href="http://marz.is-programmer.com/posts/20048.html">marz.is-programmer.com/posts/20048.html</a></pre><pre>我尝试把内容输入到地址栏, 发现文件名是问题, 没有文件名啊</pre><pre>搜索之后发现人买说协议当中没有定义关于文件名的内容, 因此没有通用的办法</pre><pre><a href="http://stackoverflow.com/questions/283956/is-there-any-way-to-specify-a-suggested-filename-when-using-data-uri">stackoverflow.com/questions/283956/is-there-any-way-to-specify-a-suggested-filename-when-using-data-uri</a></pre><pre><a href="http://stackoverflow.com/questions/8792616/downloading-file-from-dataurl-in-javascript">stackoverflow.com/questions/8792616/downloading-file-from-dataurl-in-javascript</a></pre><pre> </pre><pre>没办法, 但 Node 能单独传文件名的, 于是搜写文件的代码, 简单</pre><pre><a href="http://stackoverflow.com/questions/6926016/nodejs-saving-a-base64-encoded-image-to-disk">stackoverflow.com/questions/6926016/nodejs-saving-a-base64-encoded-image-to-disk</a></pre><pre>我用 coffee 仿写的版本, 然后运行了一下, 成功了</pre><pre>coffee:</pre><pre class='code_block'><pre>save = (data) -&gt;</pre><div class='code_block'><pre>data =  data.replace /^\w+\:\w+\/\w+\;base64\,/, ''</pre><pre>dataBuffer = new Buffer data, 'base64'</pre><pre>fs.writeFile 'a.zip', dataBuffer, (err) -&gt;</pre><div class='code_block'><pre>show err</pre><pre>show 'end'</pre></div></div></code></pre><pre> </pre><pre>这样成功了意味着所有文件可以读取为字符串, 然后通过 <code class="inline_code">socket.io</code> 传输</pre><pre>这样的话, 我通过一个服务器转发, 相互分享文件, 理论是可行的</pre><pre>文件名的话, 在 Chrome 里面还是用 trick, 不然手动也勉强接受</pre><pre>明天开始播放器的界面部分吧, 本来还以为今天能弄完的..</pre><pre> </pre><div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'jiyinyiyong';
      // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          if (document.getElementsByTagName('head')[0]) {
            document.getElementsByTagName('body')[0].appendChild(dsq);
          }
      })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
      comments powered by Disqus.
    </a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">
    comments powered by
    <span class="logo-disqus">
      Disqus
    </span>
  </a>
</div></div>