<title>OAuth 登录 Github 以及 weibo</title><meta charset='utf-8'>  <div id='article'><a id='home' href='../index.html'>Home</a><link rel="stylesheet" href="../style.css"><pre> </pre><pre><pre class='title'>OAuth 登录 Github 以及 weibo</pre></pre><pre> </pre><pre>早就想学微博登录做应用, 努力多次, 现在终于把代码过了一遍</pre><pre>像我抱怨的, 如果有清晰的 demo, 几个小时就能梳一遍, 不用我这样半个月</pre><pre>我属打渔晒网之流, 又只能独自摸索, 结果迷路的次数可想而知</pre><pre>按现在的速度, coffee 论坛怕要泡汤, 现在也要先搁一下</pre><pre> </pre><pre>代码在 GitCafe 上, 乱了, 难以梳理, 这里不期待能理一遍了</pre><pre><a href="http://gitcafe.com/jiyinyiyong/oauth-code/">gitcafe.com/jiyinyiyong/oauth-code/</a></pre><pre>另外重要的是账户上关于跨域的网址设置, weibo 尤多, 不要遗漏</pre><pre>我是按照从网页获取 access_token 的思路搜资料的, 不同于客户端</pre><pre> </pre><pre><b>流程</b></pre><pre>OAuth 的认证过程在 weibo 的 API 文档里有清晰的配图</pre><pre><a href="http://open.weibo.com/wiki/Oauth2/authorize">open.weibo.com/wiki/Oauth2/authorize</a></pre><pre>具体到网页, 先发起请求 A 到目标网站的页面下登录, 如新浪的授权页</pre><pre>授权页登录之后从 B 过程能得到一个 token, 是在 URL 里的</pre><pre>URL 的数据拿过来再发起请求 C, 凭着 <code class="inline_code">token</code> 能通过 D 过程换到一个 <code class="inline_code">access_token</code></pre><pre>再之后, 只要向正确的 URL 发起 HTTP 请求, 附带可行的参数时即可获取数据</pre><pre><code class="inline_code">access_token</code> 就是这里最首要的数据, 通常以参数形式追加在 URL 发起请求</pre><pre>原先需要用户帐号才能请求的数据, 通过 <code class="inline_code">access_token</code> 即可请求到</pre><pre><code class="inline_code">access_token</code> 是要用户授权的, 但不含密码, 因而保证了安全性</pre><pre> </pre><pre><b>认证步骤</b></pre><pre> </pre><pre>之前别忘注册应用获取访问 API 所需的 <code class="inline_code">client_id</code> 和 <code class="inline_code">client_secret</code></pre><pre>上面这些, 是从这篇文章理出来的 <a href="http://ikeepu.com/bar/10430988">ikeepu.com/bar/10430988</a></pre><pre>认证的过程, 首先打开授权页很简单, 因为只要用 <code class="inline_code">open()</code> 打开固定的 URL 即可</pre><pre>注意这个 URL 参数中有 <code class="inline_code">client_id</code> 表明用户身份, 写上即可</pre><pre> </pre><pre>登录授权的操作之后, 网页会被重定向, 重定向大致是在 HTTP Header 完成的</pre><pre>即是说, 重定向步骤由服务器完成, 重定向后的网址参数里带有 <code class="inline_code">token</code></pre><pre>虽然 <code class="inline_code">location</code> 很好获取, 但要传给另一个网页, 手法就不好想了</pre><pre>这里用了跨标签的通信, 通过 <code class="inline_code">postMessage()</code> 向 <code class="inline_code">opener</code> 发送 URL 的字符数据</pre><pre>原来的网页, 也就是 <code class="inline_code">opener</code> 写好事件监听函数, 用来捕获数据. 具体见代码</pre><pre> </pre><pre><code class="inline_code">token</code> 换 <code class="inline_code">access_token</code> 这步需要从服务器发 HTTP 请求, 而不能直接从浏览器请求</pre><pre>这一步还要用加上 <code class="inline_code">client_secret</code> 参数, 在创建应用的信息里有的</pre><pre>我很不解为什么要有中间的 <code class="inline_code">token</code> 步骤, 而不是一步直接获得 <code class="inline_code">access_token</code> 呢?</pre><pre>资料上的提示, 安全考虑.. 还是再看吧</pre><pre>浏览器服务器交换数据, 我用 <code class="inline_code">socket.io</code> 解决了, 见 GitCafe 上代码</pre><pre> </pre><pre><b>请求数据</b></pre><pre> </pre><pre>关于 API 数据的请求我只是做了简单的测试, 用 <code class="inline_code">request</code> 模块和 jQuery 完成</pre><pre>最开始我用 Node 的 Stream API 写了, 发现我不太会, 出错好多次</pre><pre>HTTP 请求是古怪的字符串, 本来 API 就应该有良好的包装才是</pre><pre><code class="inline_code">request</code> 与 jQuery 的级联写法有差别, 还是 Node 那类回调</pre><pre><a href="https://github.com/mikeal/request/">github.com/mikeal/request/</a></pre><pre> </pre><pre>Github 的 API 文档难以看懂, 我勉强对着 curl 命令找到了用户数据的 curl 命令</pre><pre>测试时用 curl 尝试 API 是否正确比代码里写更好, 也不会有浏览器的跨域问题(推测)</pre><pre>以后得仔细看下那的文档.. 标记得太抽象了..</pre><pre>浏览器端的请求在获取 Github 用户数据时没遇到大的问题, 注意写法和 URL 就好了</pre><pre> </pre><pre>在微博时有跨域的粗无, 我找了很久, 差点怀疑浏览器无法请求数据, 最后还是可以的</pre><pre>网上的办法是用 jQuery 中 jsonp 的写法避开了跨域的限制, 但代码是简单的</pre><pre><a href="http://liangge0218.iteye.com/blog/1537197">liangge0218.iteye.com/blog/1537197</a></pre><pre><a href="http://pldream.com/b/?post=72">pldream.com/b/?post=72</a></pre><pre> </pre><pre><b>...</b></pre><pre>我用了服务器上的 Nginx 来调试, 大概避免了不少麻烦</pre><pre>HTTP 是 20 年前创建的规范了, 当时没有 JSON, 连 JS 都不存在</pre><pre>尽管几经修订, 最后还是等 SPDY 和 WebSocket 之类技术来演进 Web</pre><pre><code class="inline_code">socket.io</code> 互传 JSON 对比在 URL 上绑参数, 友好程度的差别可想而知</pre><pre>如果只是传输 JSON, 接口能相当地简化. 其次是安全方面的问题</pre><pre>想想背后真有多少历史因素呢.. 希望 Node 赶快普及吧, 观念上带来改变</pre><pre> </pre><div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'jiyinyiyong';
      // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          if (document.getElementsByTagName('head')[0]) {
            document.getElementsByTagName('body')[0].appendChild(dsq);
          }
      })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">
      comments powered by Disqus.
    </a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">
    comments powered by
    <span class="logo-disqus">
      Disqus
    </span>
  </a>
</div></div>